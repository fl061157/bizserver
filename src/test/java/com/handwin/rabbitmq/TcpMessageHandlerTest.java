package com.handwin.rabbitmq;

import com.handwin.utils.SystemConstant;
import org.junit.Before;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.GenericXmlApplicationContext;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;
import java.util.concurrent.CountDownLatch;

//@RunWith(SpringJUnit4ClassRunner.class)
//@ContextConfiguration("/xmls/config-loading.xml")
public class TcpMessageHandlerTest {

    CountDownLatch latch = new CountDownLatch(1);
    ;
    @Autowired
    private TcpMessageHandler tcpMessageHandler;

    private byte[] tcp2bizMsg = new byte[]{(byte) 0x0A, (byte) 0x20, (byte) 0x62, (byte) 0x66, (byte) 0x66, (byte) 0x34, (byte) 0x33, (byte) 0x37, (byte) 0x35, (byte) 0x30, (byte) 0x37, (byte) 0x36, (byte) 0x31, (byte) 0x37, (byte) 0x31, (byte) 0x31,
            (byte) 0x65, (byte) 0x34, (byte) 0x62, (byte) 0x62, (byte) 0x32, (byte) 0x61, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x63, (byte) 0x32, (byte) 0x39, (byte) 0x30, (byte) 0x30, (byte) 0x37, (byte) 0x31,
            (byte) 0x38, (byte) 0x61, (byte) 0x12, (byte) 0x27, (byte) 0x74, (byte) 0x63, (byte) 0x70, (byte) 0x31, (byte) 0x33, (byte) 0x31, (byte) 0x5F, (byte) 0x38, (byte) 0x62, (byte) 0x35, (byte) 0x65, (byte) 0x66,
            (byte) 0x31, (byte) 0x61, (byte) 0x32, (byte) 0x37, (byte) 0x36, (byte) 0x30, (byte) 0x63, (byte) 0x31, (byte) 0x31, (byte) 0x65, (byte) 0x34, (byte) 0x61, (byte) 0x64, (byte) 0x36, (byte) 0x38, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x63, (byte) 0x32, (byte) 0x39, (byte) 0x30, (byte) 0x30, (byte) 0x37, (byte) 0x31, (byte) 0x38, (byte) 0x61, (byte) 0x1A, (byte) 0x20, (byte) 0x36, (byte) 0x62, (byte) 0x35,
            (byte) 0x35, (byte) 0x36, (byte) 0x34, (byte) 0x63, (byte) 0x34, (byte) 0x37, (byte) 0x36, (byte) 0x31, (byte) 0x34, (byte) 0x31, (byte) 0x31, (byte) 0x65, (byte) 0x34, (byte) 0x61, (byte) 0x61, (byte) 0x36,
            (byte) 0x66, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x63, (byte) 0x32, (byte) 0x39, (byte) 0x30, (byte) 0x30, (byte) 0x37, (byte) 0x31, (byte) 0x38, (byte) 0x61, (byte) 0x22, (byte) 0x09, (byte) 0x31,
            (byte) 0x32, (byte) 0x37, (byte) 0x2E, (byte) 0x30, (byte) 0x2E, (byte) 0x30, (byte) 0x2E, (byte) 0x31, (byte) 0x28, (byte) 0xCA, (byte) 0x95, (byte) 0x02, (byte) 0x32, (byte) 0x20, (byte) 0x66, (byte) 0x65,
            (byte) 0x64, (byte) 0x33, (byte) 0x33, (byte) 0x33, (byte) 0x39, (byte) 0x32, (byte) 0x64, (byte) 0x33, (byte) 0x61, (byte) 0x34, (byte) 0x38, (byte) 0x61, (byte) 0x61, (byte) 0x31, (byte) 0x34, (byte) 0x39,
            (byte) 0x61, (byte) 0x38, (byte) 0x37, (byte) 0x61, (byte) 0x33, (byte) 0x38, (byte) 0x62, (byte) 0x38, (byte) 0x37, (byte) 0x35, (byte) 0x62, (byte) 0x61, (byte) 0x34, (byte) 0x61, (byte) 0x38, (byte) 0x00,
            (byte) 0x40, (byte) 0xA1, (byte) 0xF5, (byte) 0xE1, (byte) 0xC9, (byte) 0x02, (byte) 0x4A, (byte) 0x20, (byte) 0x61, (byte) 0x61, (byte) 0x36, (byte) 0x38, (byte) 0x63, (byte) 0x37, (byte) 0x35, (byte) 0x63,
            (byte) 0x34, (byte) 0x61, (byte) 0x37, (byte) 0x37, (byte) 0x63, (byte) 0x38, (byte) 0x37, (byte) 0x66, (byte) 0x39, (byte) 0x37, (byte) 0x66, (byte) 0x62, (byte) 0x36, (byte) 0x38, (byte) 0x36, (byte) 0x62,
            (byte) 0x32, (byte) 0x66, (byte) 0x30, (byte) 0x36, (byte) 0x38, (byte) 0x36, (byte) 0x37, (byte) 0x36, (byte) 0x50, (byte) 0x00, (byte) 0x5A, (byte) 0x04, (byte) 0x30, (byte) 0x30, (byte) 0x38, (byte) 0x36,
            (byte) 0x60, (byte) 0x01, (byte) 0x6A, (byte) 0xDD, (byte) 0x01, (byte) 0xB7, (byte) 0x00, (byte) 0x05, (byte) 0x00, (byte) 0x01, (byte) 0x49, (byte) 0xF0, (byte) 0x82, (byte) 0x2A, (byte) 0xAE, (byte) 0x3E,
            (byte) 0xC7, (byte) 0x00, (byte) 0xCD, (byte) 0x00, (byte) 0x00, (byte) 0x01, (byte) 0x01, (byte) 0x39, (byte) 0x32, (byte) 0x34, (byte) 0x36, (byte) 0x34, (byte) 0x34, (byte) 0x34, (byte) 0x64, (byte) 0x39,
            (byte) 0x34, (byte) 0x66, (byte) 0x30, (byte) 0x38, (byte) 0x31, (byte) 0x65, (byte) 0x33, (byte) 0x35, (byte) 0x34, (byte) 0x39, (byte) 0x38, (byte) 0x30, (byte) 0x33, (byte) 0x62, (byte) 0x39, (byte) 0x32,
            (byte) 0x38, (byte) 0x32, (byte) 0x36, (byte) 0x30, (byte) 0x66, (byte) 0x35, (byte) 0x36, (byte) 0x00, (byte) 0x73, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x00, (byte) 0x00, (byte) 0x00, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30, (byte) 0x30,
            (byte) 0x30, (byte) 0x30, (byte) 0x72, (byte) 0x04, (byte) 0x30, (byte) 0x30, (byte) 0x38, (byte) 0x36, (byte) 0x78, (byte) 0x01, (byte) 0x80, (byte) 0x01, (byte) 0x00};


    @Before
    public void before() {
//        System.setProperty("spring.profiles.active", "test-mock-cn");


        initSystem(latch);

    }



    private void initSystem(CountDownLatch latch) {
        String nodeId = System.getProperty("node.id");
        if(null == nodeId) nodeId = String.valueOf(SystemConstant.NODE_ID_DEFAULT);
        String nodeIp = System.getProperty("node.ip");
        if(null == nodeIp) nodeIp = SystemConstant.NODE_IP_DEFAULT;
        System.setProperty("LOG_PREFIX", String.format("[biz:%s]", nodeId));
        System.setProperty("LOG_FLUME_IP", nodeIp);

        String prefix = "classpath:";
        String loading = "config-loading.xml";
        String dir = "xmls";

        System.setProperty("spring.profiles.active", "test-mock-cn");
        final GenericXmlApplicationContext context = new GenericXmlApplicationContext();

        context.load(prefix + dir + File.separatorChar + loading);

        new Thread(() -> {

            try {
                Thread.sleep(10 * 1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            tcpMessageHandler = (TcpMessageHandler) context.getBean("tcpMessageHandler");

            latch.countDown();

        }).start();

        new Thread(() -> context.refresh()).start();

    }

}